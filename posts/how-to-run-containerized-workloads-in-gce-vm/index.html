<!doctype html><html lang=en dir=auto data-theme=dark><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to run containerized workloads in GCE VM | Mark Chmarny</title><meta name=keywords content="vm,container,gce,google"><meta name=description content="While the idea of a serverless platform and long running workloads does seem somewhat &ldquo;unnatural&rdquo; at first, smart people are already working on that (looking at you @Knative community). In the meantime, a simple approach is sometimes all you may need."><meta name=author content="Mark Chmarny"><link rel=canonical href=https://blog.chmarny.com/posts/how-to-run-containerized-workloads-in-gce-vm/><link crossorigin=anonymous href=/assets/css/stylesheet.5bef4b698d33ee9d58f22269d129fe3c725b1b3356a4ed1ded10651b773f88c5.css integrity="sha256-W+9LaY0z7p1Y8iJp0Sn+PHJbGzNWpO0d7RBlG3c/iMU=" rel="preload stylesheet" as=style><link rel=icon href=https://blog.chmarny.com/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.chmarny.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.chmarny.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.chmarny.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.chmarny.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.chmarny.com/posts/how-to-run-containerized-workloads-in-gce-vm/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script>localStorage.getItem("pref-theme")==="light"&&(document.querySelector("html").dataset.theme="light")</script><meta property="og:url" content="https://blog.chmarny.com/posts/how-to-run-containerized-workloads-in-gce-vm/"><meta property="og:site_name" content="Mark Chmarny"><meta property="og:title" content="How to run containerized workloads in GCE VM"><meta property="og:description" content="While the idea of a serverless platform and long running workloads does seem somewhat “unnatural” at first, smart people are already working on that (looking at you @Knative community). In the meantime, a simple approach is sometimes all you may need."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-21T22:10:24+00:00"><meta property="article:modified_time" content="2019-08-21T22:10:24+00:00"><meta property="article:tag" content="Vm"><meta property="article:tag" content="Container"><meta property="article:tag" content="Gce"><meta property="article:tag" content="Google"><meta property="og:image" content="https://blog.chmarny.com/images/site-feature-image.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.chmarny.com/images/site-feature-image.png"><meta name=twitter:title content="How to run containerized workloads in GCE VM"><meta name=twitter:description content="While the idea of a serverless platform and long running workloads does seem somewhat &ldquo;unnatural&rdquo; at first, smart people are already working on that (looking at you @Knative community). In the meantime, a simple approach is sometimes all you may need."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.chmarny.com/posts/"},{"@type":"ListItem","position":2,"name":"How to run containerized workloads in GCE VM","item":"https://blog.chmarny.com/posts/how-to-run-containerized-workloads-in-gce-vm/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to run containerized workloads in GCE VM","name":"How to run containerized workloads in GCE VM","description":"While the idea of a serverless platform and long running workloads does seem somewhat \u0026ldquo;unnatural\u0026rdquo; at first, smart people are already working on that (looking at you @Knative community). In the meantime, a simple approach is sometimes all you may need.\n","keywords":["vm","container","gce","google"],"articleBody":"While the idea of a serverless platform and long running workloads does seem somewhat “unnatural” at first, smart people are already working on that (looking at you @Knative community). In the meantime, a simple approach is sometimes all you may need.\nIn this post I will illustrating how to use Google Compute Engine (GCE) container execution option to run variable duration jobs. This approach supports custom VMs, GPU/TPU accelerators and VPC networks… so may be handy alternative to other compute options on GCP. I’ll also demo how to auto-terminate the created VM on container completion, so you won’t have to pay for idle VM time.\nFinally, in this example I’ll parses small gzip file from Google Cloud Storage (GCS), but since this approach is not limited by client timeouts you can use it to do pretty much anything… transformations on bigger files, lightweight ETL, or media format encoding. You can even combine it with GCP Task Queue for more complex pipelines.\nPre-requirements If you don’t have one already, create new GCP project and configuring Google Cloud SDK.\nSetup To start, clone this repo, and navigate into that directory:\ngit clone [https://github.com/mchmarny/long-running-job.git](https://github.com/mchmarny/long-running-job.git) cd long-running-job Also, to streamline the subsequent commands, we are going to export a few variables:\nexport PROJECT=$(gcloud config get-value project) export APP_NAME=\"my-long-job\" export SA_NAME=\"${APP_NAME}@${PROJECT}.iam.gserviceaccount.com\" Service Account To execute this sample you will need a GCP service account. You can do that either in UI or using gcloud SDK.\ngcloud iam service-accounts create $APP_NAME \\ --display-name \"Service Invoker Account for ${APP_NAME}\" We also will have to assign this account the necessary IAM roles:\ngcloud projects add-iam-policy-binding $PROJECT \\ --member \"serviceAccount:${SA_NAME}\" \\ --role roles/logging.logWriter gcloud projects add-iam-policy-binding $PROJECT \\ --member \"serviceAccount:${SA_NAME}\" \\ --role roles/cloudtrace.agent gcloud projects add-iam-policy-binding $PROJECT \\ --member \"serviceAccount:${SA_NAME}\" \\ --role roles/monitoring.metricWriter gcloud projects add-iam-policy-binding $PROJECT \\ --member \"serviceAccount:${SA_NAME}\" \\ --role roles/storage.objectViewer gcloud projects add-iam-policy-binding $PROJECT \\ --member \"serviceAccount:${SA_NAME}\" \\ --role roles/pubsub.editor gcloud projects add-iam-policy-binding $PROJECT \\ --member \"serviceAccount:${SA_NAME}\" \\ --role roles/compute.instanceAdmin Finally, to enable our demo to impersonate that account, we will need to provision a key for that account which will be saved in your home directory. You should protect that key or just delete it after this demo.\ngcloud iam service-accounts keys create \\ --iam-account $SA_NAME \"${HOME}/.${APP_NAME}-sa.json\" Container Image The unit of workload in this example is container image. To create an image from the source code in this demo, first vendor all the go dependencies:\ngo mod tidy go mod vendor And then submit the image build request to Cloud Build:\ngcloud builds submit --tag \"gcr.io/${PROJECT}/${APP_NAME}:0.0.1\" If successful, you should see a confirmation with the fully qualified URI to the created image.\nDeploy Container to VM Now to start a new VM and configure it to run the above built image. This sample will use gzipped CSV file (100-Sales-Records.csv.gz) located in publicly available GCS bucket (long-running-job-src-files). If you want you can replace these with your own files.\ngcloud compute instances create-with-container $APP_NAME \\ --container-image=\"gcr.io/${PROJECT}/${APP_NAME}:0.0.1\" \\ --machine-type=n1-standard-1 \\ --zone=us-central1-c \\ --image-family=cos-stable \\ --image-project=cos-cloud \\ --maintenance-policy=MIGRATE \\ --scopes=cloud-platform \\ --container-privileged \\ --container-env=\"GOOGLE_APPLICATION_CREDENTIALS=/tmp/sa.pem,BUCKET=long-running-job-src-files,OBJECT=100-Sales-Records.csv.gz,TOPIC=${APP_NAME}\" \\ --container-mount-host-path=mount-path=/tmp,host-path=/tmp,mode=rw There is no way right now to upload files in the same command, so right after, you need copy the service account key created above to the new VM. The container is set to restart on failure so it will automatically use the key when it becomes available in the mounted volume attached to our VM.\ngcloud compute scp \"${HOME}/.${APP_NAME}-sa.json\" \\ \"${APP_NAME}:/tmp/sa.pem\" --zone=us-central1-c Container Logs Once the VM has started you can monitor the logs output from the container to Stackdriver. To do that we need to first capture the VM instance Id:\nexport VM_INSTANCE_ID=$(gcloud compute instances describe \\ $APP_NAME --zone=us-central1-c --format=\"value(id)\") Once we have captured the VM instance ID we can now query the Stackdriver for logs output by the container:\ngcloud logging read \"resource.type=gce_instance AND \\ logName=projects/${PROJECT}/logs/cos_containers AND \\ resource.labels.instance_id=${VM_INSTANCE_ID} AND \\ jsonPayload.message:\\\"\\[LRJ\\]\\\"\" \\ --order=\"asc\" Note, this command will print only the logs that are output by the user code in the container (the logger inside prefixes all log entries with “[LRJ]”). You can see the complete list of log entries by removing the__jsonPayload.message:\"[LRJ]\"_ filter.\nAfter the container exists, the VM will automatically shutdown but the logs should still be still available in Stackdriver for forensic analyses.\nConclusion I hope you find this helpful addition to your GCP compute toolbox. You can find the source code along with scripts for easier execution at https://github.com/mchmarny/long-running-job\n","wordCount":"734","inLanguage":"en","image":"https://blog.chmarny.com/images/site-feature-image.png","datePublished":"2019-08-21T22:10:24.158Z","dateModified":"2019-08-21T22:10:24.158Z","author":{"@type":"Person","name":"Mark Chmarny"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.chmarny.com/posts/how-to-run-containerized-workloads-in-gce-vm/"},"publisher":{"@type":"Organization","name":"Mark Chmarny","logo":{"@type":"ImageObject","url":"https://blog.chmarny.com/favicons/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://blog.chmarny.com/ accesskey=h title="Mark Chmarny (Alt + H)">Mark Chmarny</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.chmarny.com/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://blog.chmarny.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://blog.chmarny.com/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://blog.chmarny.com/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://blog.chmarny.com/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.chmarny.com/>Home</a>&nbsp;»&nbsp;<a href=https://blog.chmarny.com/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">How to run containerized workloads in GCE VM</h1><div class=post-meta><span title='2019-08-21 22:10:24.158 +0000 UTC'>2019-08-21</span>&nbsp;·&nbsp;<span>4 min</span>&nbsp;·&nbsp;<span>Mark Chmarny</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#pre-requirements aria-label=Pre-requirements>Pre-requirements</a></li><li><a href=#setup aria-label=Setup>Setup</a></li><li><a href=#service-account aria-label="Service Account">Service Account</a></li><li><a href=#container-image aria-label="Container Image">Container Image</a></li><li><a href=#deploy-container-to-vm aria-label="Deploy Container to VM">Deploy Container to VM</a></li><li><a href=#container-logs aria-label="Container Logs">Container Logs</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><p>While the idea of a serverless platform and long running workloads does seem somewhat &ldquo;unnatural&rdquo; at first, smart people are already working on that (looking at you <a href=http://twitter.com/KnativeProject>@Knative</a> community). In the meantime, a simple approach is sometimes all you may need.</p><p>In this post I will illustrating how to use Google Compute Engine (GCE) container execution option to run variable duration jobs. This approach supports custom VMs, GPU/TPU accelerators and VPC networks… so may be handy alternative to other compute options on GCP. I’ll also demo how to auto-terminate the created VM on container completion, so you won’t have to pay for idle VM time.</p><p>Finally, in this example I’ll parses small gzip file from Google Cloud Storage (GCS), but since this approach is not limited by client timeouts you can use it to do pretty much anything… transformations on bigger files, lightweight ETL, or media format encoding. You can even combine it with <a href=https://cloud.google.com/appengine/docs/standard/python/taskqueue/>GCP Task Queue</a> for more complex pipelines.</p><h2 id=pre-requirements>Pre-requirements<a hidden class=anchor aria-hidden=true href=#pre-requirements>#</a></h2><p>If you don’t have one already, create new GCP project and configuring <a href=https://cloud.google.com/sdk/docs/>Google Cloud SDK</a>.</p><h2 id=setup>Setup<a hidden class=anchor aria-hidden=true href=#setup>#</a></h2><p>To start, clone this repo, and navigate into that directory:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git clone <span class=o>[</span>https://github.com/mchmarny/long-running-job.git<span class=o>](</span>https://github.com/mchmarny/long-running-job.git<span class=o>)</span>  
</span></span><span class=line><span class=cl><span class=nb>cd</span> long-running-job
</span></span></code></pre></div><p>Also, to streamline the subsequent commands, we are going to export a few variables:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PROJECT</span><span class=o>=</span><span class=k>$(</span>gcloud config get-value project<span class=k>)</span>  
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>APP_NAME</span><span class=o>=</span><span class=s2>&#34;my-long-job&#34;</span>  
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>SA_NAME</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>APP_NAME</span><span class=si>}</span><span class=s2>@</span><span class=si>${</span><span class=nv>PROJECT</span><span class=si>}</span><span class=s2>.iam.gserviceaccount.com&#34;</span>
</span></span></code></pre></div><h2 id=service-account>Service Account<a hidden class=anchor aria-hidden=true href=#service-account>#</a></h2><p>To execute this sample you will need a <a href=https://cloud.google.com/iam/docs/creating-managing-service-accounts>GCP service account</a>. You can do that either in UI or using <code>gcloud</code> SDK.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gcloud iam service-accounts create <span class=nv>$APP_NAME</span> <span class=se>\ </span> 
</span></span><span class=line><span class=cl>  --display-name <span class=s2>&#34;Service Invoker Account for </span><span class=si>${</span><span class=nv>APP_NAME</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>We also will have to assign this account the necessary IAM roles:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gcloud projects add-iam-policy-binding <span class=nv>$PROJECT</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --member <span class=s2>&#34;serviceAccount:</span><span class=si>${</span><span class=nv>SA_NAME</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --role roles/logging.logWriter
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gcloud projects add-iam-policy-binding <span class=nv>$PROJECT</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --member <span class=s2>&#34;serviceAccount:</span><span class=si>${</span><span class=nv>SA_NAME</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --role roles/cloudtrace.agent
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gcloud projects add-iam-policy-binding <span class=nv>$PROJECT</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --member <span class=s2>&#34;serviceAccount:</span><span class=si>${</span><span class=nv>SA_NAME</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --role roles/monitoring.metricWriter
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gcloud projects add-iam-policy-binding <span class=nv>$PROJECT</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --member <span class=s2>&#34;serviceAccount:</span><span class=si>${</span><span class=nv>SA_NAME</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --role roles/storage.objectViewer
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gcloud projects add-iam-policy-binding <span class=nv>$PROJECT</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --member <span class=s2>&#34;serviceAccount:</span><span class=si>${</span><span class=nv>SA_NAME</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --role roles/pubsub.editor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gcloud projects add-iam-policy-binding <span class=nv>$PROJECT</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --member <span class=s2>&#34;serviceAccount:</span><span class=si>${</span><span class=nv>SA_NAME</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --role roles/compute.instanceAdmin
</span></span></code></pre></div><p>Finally, to enable our demo to impersonate that account, we will need to provision a key for that account which will be saved in your home directory. You should protect that key or just delete it after this demo.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gcloud iam service-accounts keys create <span class=se>\
</span></span></span><span class=line><span class=cl>  --iam-account <span class=nv>$SA_NAME</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>HOME</span><span class=si>}</span><span class=s2>/.</span><span class=si>${</span><span class=nv>APP_NAME</span><span class=si>}</span><span class=s2>-sa.json&#34;</span>
</span></span></code></pre></div><h2 id=container-image>Container Image<a hidden class=anchor aria-hidden=true href=#container-image>#</a></h2><p>The unit of workload in this example is container image. To create an image from the source code in this demo, first vendor all the go dependencies:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>go mod tidy  
</span></span><span class=line><span class=cl>go mod vendor
</span></span></code></pre></div><p>And then submit the image build request to Cloud Build:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gcloud builds submit --tag <span class=s2>&#34;gcr.io/</span><span class=si>${</span><span class=nv>PROJECT</span><span class=si>}</span><span class=s2>/</span><span class=si>${</span><span class=nv>APP_NAME</span><span class=si>}</span><span class=s2>:0.0.1&#34;</span>
</span></span></code></pre></div><p>If successful, you should see a confirmation with the fully qualified URI to the created image.</p><h2 id=deploy-container-to-vm>Deploy Container to VM<a hidden class=anchor aria-hidden=true href=#deploy-container-to-vm>#</a></h2><p>Now to start a new VM and configure it to run the above built image. This sample will use gzipped CSV file (100-Sales-Records.csv.gz) located in publicly available GCS bucket (long-running-job-src-files). If you want you can replace these with your own files.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gcloud compute instances create-with-container <span class=nv>$APP_NAME</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --container-image<span class=o>=</span><span class=s2>&#34;gcr.io/</span><span class=si>${</span><span class=nv>PROJECT</span><span class=si>}</span><span class=s2>/</span><span class=si>${</span><span class=nv>APP_NAME</span><span class=si>}</span><span class=s2>:0.0.1&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --machine-type<span class=o>=</span>n1-standard-1 <span class=se>\
</span></span></span><span class=line><span class=cl>  --zone<span class=o>=</span>us-central1-c <span class=se>\
</span></span></span><span class=line><span class=cl>  --image-family<span class=o>=</span>cos-stable <span class=se>\
</span></span></span><span class=line><span class=cl>  --image-project<span class=o>=</span>cos-cloud <span class=se>\
</span></span></span><span class=line><span class=cl>  --maintenance-policy<span class=o>=</span>MIGRATE <span class=se>\
</span></span></span><span class=line><span class=cl>  --scopes<span class=o>=</span>cloud-platform <span class=se>\
</span></span></span><span class=line><span class=cl>  --container-privileged <span class=se>\
</span></span></span><span class=line><span class=cl>  --container-env<span class=o>=</span><span class=s2>&#34;GOOGLE_APPLICATION_CREDENTIALS=/tmp/sa.pem,BUCKET=long-running-job-src-files,OBJECT=100-Sales-Records.csv.gz,TOPIC=</span><span class=si>${</span><span class=nv>APP_NAME</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --container-mount-host-path<span class=o>=</span>mount-path<span class=o>=</span>/tmp,host-path<span class=o>=</span>/tmp,mode<span class=o>=</span>rw
</span></span></code></pre></div><p>There is no way right now to upload files in the same command, so right after, you need copy the service account key created above to the new VM. The container is set to restart on failure so it will automatically use the key when it becomes available in the mounted volume attached to our VM.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gcloud compute scp <span class=s2>&#34;</span><span class=si>${</span><span class=nv>HOME</span><span class=si>}</span><span class=s2>/.</span><span class=si>${</span><span class=nv>APP_NAME</span><span class=si>}</span><span class=s2>-sa.json&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  <span class=s2>&#34;</span><span class=si>${</span><span class=nv>APP_NAME</span><span class=si>}</span><span class=s2>:/tmp/sa.pem&#34;</span> --zone<span class=o>=</span>us-central1-c
</span></span></code></pre></div><h2 id=container-logs>Container Logs<a hidden class=anchor aria-hidden=true href=#container-logs>#</a></h2><p>Once the VM has started you can monitor the logs output from the container to <a href=https://cloud.google.com/stackdriver/>Stackdriver</a>. To do that we need to first capture the VM instance Id:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>export</span> <span class=nv>VM_INSTANCE_ID</span><span class=o>=</span><span class=k>$(</span>gcloud compute instances describe <span class=se>\
</span></span></span><span class=line><span class=cl>  <span class=nv>$APP_NAME</span> --zone<span class=o>=</span>us-central1-c --format<span class=o>=</span><span class=s2>&#34;value(id)&#34;</span><span class=k>)</span>
</span></span></code></pre></div><p>Once we have captured the VM instance ID we can now query the <a href=https://cloud.google.com/stackdriver/>Stackdriver</a> for logs output by the container:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>gcloud logging <span class=nb>read</span> <span class=s2>&#34;resource.type=gce_instance AND \
</span></span></span><span class=line><span class=cl><span class=s2>  logName=projects/</span><span class=si>${</span><span class=nv>PROJECT</span><span class=si>}</span><span class=s2>/logs/cos_containers AND \
</span></span></span><span class=line><span class=cl><span class=s2>  resource.labels.instance_id=</span><span class=si>${</span><span class=nv>VM_INSTANCE_ID</span><span class=si>}</span><span class=s2> AND \
</span></span></span><span class=line><span class=cl><span class=s2>  jsonPayload.message:\&#34;\[LRJ\]\&#34;&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  --order<span class=o>=</span><span class=s2>&#34;asc&#34;</span>
</span></span></code></pre></div><blockquote><p>Note, this command will print only the logs that are output by the user code in the container (the logger inside prefixes all log entries with &ldquo;[LRJ]&rdquo;). You can see the complete list of log entries by removing the_<code>_jsonPayload.message:"[LRJ]"_</code> filter.</p></blockquote><p>After the container exists, the VM will automatically shutdown but the logs should still be still available in Stackdriver for forensic analyses.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>I hope you find this helpful addition to your GCP compute toolbox. You can find the source code along with scripts for easier execution at <a href=https://github.com/mchmarny/long-running-job>https://github.com/mchmarny/long-running-job</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.chmarny.com/tags/vm/>Vm</a></li><li><a href=https://blog.chmarny.com/tags/container/>Container</a></li><li><a href=https://blog.chmarny.com/tags/gce/>Gce</a></li><li><a href=https://blog.chmarny.com/tags/google/>Google</a></li></ul><nav class=paginav><a class=prev href=https://blog.chmarny.com/posts/how-to-debug-container-image-content/><span class=title>« Prev</span><br><span>How to debug container image content</span>
</a><a class=next href=https://blog.chmarny.com/posts/using-flick-buttons-with-cloud-run-on-gcp/><span class=title>Next »</span><br><span>Using Flick buttons with Cloud Run on GCP</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://blog.chmarny.com/>Mark Chmarny</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>