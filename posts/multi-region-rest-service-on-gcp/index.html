<!doctype html><html dir=ltr lang=en data-theme=dark><head><title>Mark Chmarny
|
Multi Region REST Service on GCP using GitHub Template</title><meta charset=utf-8><meta name=generator content="Hugo 0.104.3"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=description content="
      few longer thoughts, <br/>because every once in a while <br/>140 characters is just not enough


    "><link rel=stylesheet href=/css/main.min.179cc2d1e93212b8ec31560509068248e4269f4b648220d1154adb0d5e94aa7d.css integrity="sha256-F5zC0ekyErjsMVYFCQaCSOQmn0tkgiDRFUrbDV6Uqn0=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.058b31f17db60602cc415fd63b0427e7932fbf35c70d8e341a4c39385f5f6f3e.css integrity="sha256-BYsx8X22BgLMQV/WOwQn55MvvzXHDY40Gkw5OF9fbz4=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/custom.min.c932a7c5e2d9eb0228f2bd2992ea2d5acb4f2715f7d229cebabea22225c38356.css integrity="sha256-yTKnxeLZ6wIo8r0pkuotWstPJxX30inOur6iIiXDg1Y=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin=anonymous><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Roboto:ital,wght@0,100;0,400;0,700;1,400&display=swap" rel=stylesheet><link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=canonical href=https://blog.chmarny.com/posts/multi-region-rest-service-on-gcp/><script type=text/javascript src=/js/anatole-header.min.d0408165d31a17f17bba83038bf54e86121f85021bdf936382e636f0f77a952f.js integrity="sha256-0ECBZdMaF/F7uoMDi/VOhhIfhQIb35NjguY28Pd6lS8=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/algoliasearch@4.5.1/dist/algoliasearch-lite.umd.js integrity="sha256-EXPXz4W6pQgfYY3yTpnDa3OH8/EPn16ciVsPQ/ypsjk=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/instantsearch.js@4.8.3/dist/instantsearch.production.min.js integrity="sha256-LAGhRRdtVoD6RLo2qDQsU2mp+XVSciKRC8XPOBWmofM=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.ea8ebe268922ef9849261a1312cd65b640595e65251ce4c00534a176afd1ac0c.js integrity="sha256-6o6+Joki75hJJhoTEs1ltkBZXmUlHOTABTShdq/RrAw=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/search.min.b3a692306dd9db78b63ea76fac0b1b32033f19465563f7378cf5f7dc05811ce7.js integrity="sha256-s6aSMG3Z23i2PqdvrAsbMgM/GUZVY/c3jPX33AWBHOc=" crossorigin=anonymous></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.chmarny.com/images/site-feature-image.png"><meta name=twitter:title content="Multi Region REST Service on GCP using GitHub Template"><meta name=twitter:description content="I learn best by doing. And recently, most of the projects I&rsquo;ve been building are either REST or gRPC-base services deployed as container images into Cloud Run on GCP. That means that I increasingly find myself recreating a lot of the same infra and app deployment flows."><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"Multi Region REST Service on GCP using GitHub Template","headline":"Multi Region REST Service on GCP using GitHub Template","alternativeHeadline":"","description":"
      
        I learn best by doing. And recently, most of the projects I\u0026rsquo;ve been building are either REST or gRPC-base services deployed as container images into Cloud Run on GCP. That means that I increasingly find myself recreating a lot of the same infra and app deployment flows.


      


    ","inLanguage":"en","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.chmarny.com\/posts\/multi-region-rest-service-on-gcp\/"},"author":{"@type":"Person","name":"Mark Chmarny"},"creator":{"@type":"Person","name":"Mark Chmarny"},"accountablePerson":{"@type":"Person","name":"Mark Chmarny"},"copyrightHolder":{"@type":"Person","name":"Mark Chmarny"},"copyrightYear":"2022","dateCreated":"2022-01-05T15:43:56.00Z","datePublished":"2022-01-05T15:43:56.00Z","dateModified":"2022-01-05T15:43:56.00Z","publisher":{"@type":"Organization","name":"Mark Chmarny","url":"https://blog.chmarny.com","logo":{"@type":"ImageObject","url":"https:\/\/blog.chmarny.com\/favicons\/favicon-32x32.png","width":"32","height":"32"}},"image":["https://blog.chmarny.com/images/site-feature-image.png"],"url":"https:\/\/blog.chmarny.com\/posts\/multi-region-rest-service-on-gcp\/","wordCount":"354","genre":["dev"],"keywords":["rest","gcp","gcr","oidc","github","terraform","github"]}</script></head><body><header><div class="page-top
."><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a><nav><ul class=nav__list id=navMenu><div class=nav__links><li><a href=/ title>Home</a></li><li><a href=/posts/ title>Posts</a></li><li><a href=/search/ title>Search</a></li><li><a href=/about/ title>About</a></li></div><ul><li><a class=theme-switch title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></li></ul></ul></nav></div></header><div class=wrapper><aside><div class="sidebar
."><div class=sidebar__content><div class=logo-title><div class=title><img src=/images/profile.png alt="profile picture"><h3 title><a href=/>Mark Chmarny</a></h3><div class=description><p>few longer thoughts,<br>because every once in a while<br>140 characters is just not enough</p></div></div></div><ul class=social-links><li><a href=https://twitter.com/mchmarny rel=me aria-label=Twitter title=Twitter><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li><a href=https://github.com/mchmarny rel=me aria-label=GitHub title=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li><a href=https://speakerdeck.com/mchmarny rel=me aria-label="Speaker Deck" title="Speaker Deck"><i class="fas fa-file-powerpoint fa-2x" aria-hidden=true></i></a></li><li><a href=mailto:blog@chmarny.com rel=me aria-label=e-mail title=e-mail><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer--sidebar"><div class=by_farbox><ul class=footer__list><li class=footer__item>&copy;2022</li></ul></div></footer></div></aside><main><div class=autopagerize_page_element><div class=content><div class="post
."><div class=post-content><img class=post-thumbnail src=/images/multi-region.png alt="Thumbnail image"><div class=post-title><h1>Multi Region REST Service on GCP using GitHub Template</h1></div><p>I learn best by doing. And recently, most of the projects I&rsquo;ve been building are either REST or gRPC-base services deployed as container images into Cloud Run on GCP. That means that I increasingly find myself recreating a lot of the same infra and app deployment flows.</p><p>Over time, the stack for these services started getting also more complex. Multi-region deployment in Cloud Run, fronted by Load Balancer with custom domain and SSL cert, throttled by Cloud Armor policies, and pushing images to GCR from GitHub action without the need to provision service account keys.</p><p>So, over the holidays, I&rsquo;ve decided to automate the provisioning of the entire stack in a <a href=https://docs.github.com/en/repositories/creating-and-managing-repositories/creating-a-template-repository>GitHub template project</a> so I can quickly bootstrap new services, in a more reproducible fashion, and focus on actually writing the code, not tweaking the infra.</p><p>The result, <a href=https://github.com/mchmarny/restme>restme</a>. It&rsquo;s a <a href=https://www.terraform.io/>Terraform-based configuration</a> to provision into your GCP project a fully functional, multi-region, REST service with a secure developer release pipeline in GitHub.</p><p>Here is what&rsquo;s included:</p><ul><li><a href=https://cloud.google.com/run>Cloud Run</a> service provisioning<ul><li>Configured in an n number of regions with</li><li>Custom identity (service account)</li><li>Sample <a href=https://cloud.google.com/secret-manager>Secret Manager</a>-based variable</li><li>Configurable capacity and autoscaling strategy</li><li>Accessible only by Internal and Load Balancer traffic (no external access)</li></ul></li><li><a href=https://cloud.google.com/load-balancing/docs/https/setting-up-https>HTTPS Load Balancer</a> with external IP and<ul><li>Custom domain with SSL certificate</li><li><a href=https://cloud.google.com/armor>Cloud Armor</a> policies for throttling and Canary CVE</li><li>Serverless NEGs config for Cloud Run service in each region</li></ul></li><li>Dev and Ops Configuration for<ul><li>Container registry (GCR)</li><li>Service uptime and SSL cert expiration alerts</li><li><a href=https://docs.github.com/en/actions/deployment/security-hardening-your-deployments>IODC</a>-based <a href=https://cloud.google.com/blog/products/identity-security/enabling-keyless-authentication-from-github-actions>Workload Identity Pool short-lived credentials provider for GitHub Actions</a></li><li>Service logging with GCS bucket sink</li><li>Local test, lint, and validate actions using <a href=https://github.com/mchmarny/restme/blob/main/Makefile>Makefile</a></li><li><a href=https://github.com/mchmarny/restme/tree/main/.github/workflows>GitHub Actions</a> to <a href=https://github.com/mchmarny/restme/blob/main/.github/workflows/test-on-push.yaml>test each PR</a> and <a href=https://github.com/mchmarny/restme/blob/main/.github/workflows/image-on-tag.yaml>container image build/publish</a> to GCR on git tag</li></ul></li></ul><p>The template project also includes Go source code for very rudimentary REST services based on <a href=https://github.com/gin-gonic/gin>gin framework</a> to expedite bootstrapping new app dev:</p><ul><li><strong>[GET] Request info</strong> - client request, headers and environment variables</li><li><strong>[POST] Echo message</strong> - simple echo message</li></ul><p>This entire setup is available as a template with prerequisites and deployment instructions <a href=https://github.com/mchmarny/restme/blob/main/README.md>my GitHub repo</a>. I hope you find it as helpful as I do.</p></div><div class=post-footer><div class=info><span class=separator><a class=category href=/categories/dev/>dev</a></span>
<span class=separator><a class=tag href=/tags/rest/>rest</a><a class=tag href=/tags/gcp/>gcp</a><a class=tag href=/tags/gcr/>gcr</a><a class=tag href=/tags/oidc/>oidc</a><a class=tag href=/tags/github/>github</a><a class=tag href=/tags/terraform/>terraform</a><a class=tag href=/tags/github/>github</a></span></div></div></div></div></div></main></div><footer class="footer footer--base"><div class=by_farbox><ul class=footer__list><li class=footer__item>&copy;2022</li></ul></div></footer></body></html>